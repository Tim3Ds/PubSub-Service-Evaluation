cmake_minimum_required(VERSION 3.10)
project(zeromq_examples)

# Use centralized protobuf
set(CMAKE_PREFIX_PATH "${CMAKE_PREFIX_PATH};/home/tim/repos/utils/protobuf/build")
find_package(Protobuf REQUIRED)
include_directories(${Protobuf_INCLUDE_DIRS})

find_package(PkgConfig REQUIRED)

# Get repo root using git
execute_process(
    COMMAND git rev-parse --show-toplevel
    OUTPUT_VARIABLE REPO_ROOT
    OUTPUT_STRIP_TRAILING_WHITESPACE
)

# Use Protobuf from gRPC build deps
set(GRPC_DEPS_DIR "${REPO_ROOT}/grpc/cpp/build/deps")
set(ZMQ_DEPS_DIR "${REPO_ROOT}/zeroMQ/cpp/build/_deps")
set(CMAKE_PREFIX_PATH ${GRPC_DEPS_DIR} ${CMAKE_PREFIX_PATH})
find_package(Protobuf REQUIRED HINTS ${GRPC_DEPS_DIR})

set(CMAKE_CXX_STANDARD 17)
find_package(Threads REQUIRED)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

# Add local build/lib/pkgconfig to PKG_CONFIG_PATH for local ActiveMQ-CPP
set(ENV{PKG_CONFIG_PATH} "${CMAKE_BINARY_DIR}/lib/pkgconfig:${CMAKE_BINARY_DIR}/lib64/pkgconfig:$ENV{PKG_CONFIG_PATH}")
pkg_check_modules(ZMQ REQUIRED libzmq)
link_directories(${ZMQ_LIBRARY_DIRS}64)

message(STATUS "ZeroMQ include dirs: ${ZMQ_INCLUDE_DIRS}")
message(STATUS "ZeroMQ libraries: ${ZMQ_LIBRARIES}")
message(STATUS "Protobuf include dirs: ${Protobuf_INCLUDE_DIRS}")
message(STATUS "Protobuf libraries: ${Protobuf_LIBRARIES}")

# Compile messaging.proto
# Use generated protobuf from utils/cpp (generated by grpc build)
set(PROTO_SRCS "${REPO_ROOT}/utils/cpp/messaging.pb.cc")
set(PROTO_HDRS "${REPO_ROOT}/utils/cpp/messaging.pb.h")

# Create a library for the generated proto code
add_library(messaging_proto ${PROTO_SRCS} ${PROTO_HDRS})
target_link_libraries(messaging_proto PUBLIC protobuf::libprotobuf)
target_include_directories(messaging_proto PUBLIC "${REPO_ROOT}/utils/cpp")

# Create test_data_loader library from utils/cpp
add_library(test_data_loader STATIC ${REPO_ROOT}/utils/cpp/test_data_loader.cpp)
target_include_directories(test_data_loader PUBLIC ${REPO_ROOT}/utils/cpp)
target_link_libraries(test_data_loader PUBLIC stdc++fs)

add_executable(sender_test sender_test.cpp)
target_link_libraries(sender_test PUBLIC ${ZMQ_LIBRARIES} test_data_loader messaging_proto)
target_include_directories(sender_test PUBLIC ${ZMQ_INCLUDE_DIRS})

add_executable(receiver_test receiver_test.cpp)
target_link_libraries(receiver_test PUBLIC ${ZMQ_LIBRARIES} messaging_proto)
target_include_directories(receiver_test PUBLIC ${ZMQ_INCLUDE_DIRS})

add_executable(sender_async_test sender_async_test.cpp)
target_link_libraries(sender_async_test PUBLIC ${ZMQ_LIBRARIES} Threads::Threads messaging_proto test_data_loader)
target_include_directories(sender_async_test PUBLIC ${ZMQ_INCLUDE_DIRS})


add_executable(receiver_async_test receiver_async_test.cpp)
target_link_libraries(receiver_async_test PUBLIC ${ZMQ_LIBRARIES} Threads::Threads messaging_proto)
target_include_directories(receiver_async_test PUBLIC ${ZMQ_INCLUDE_DIRS})
